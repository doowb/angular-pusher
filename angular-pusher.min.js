"use strict";angular.module("doowb.angular-pusher",[]).provider("PusherService",function(){function createScript($document,callback){var tag=$document.createElement("script");tag.type="text/javascript",tag.async=!0,tag.id=scriptId,tag.src=scriptUrl,tag.onreadystatechange=tag.onload=function(){var state=tag.readState;callback.done||state&&!/loaded|complete/.test(state)||(callback.done=!0,callback())},$document.getElementsByTagName("head")[0].appendChild(tag)}var scriptUrl="//js.pusher.com/2.2/pusher.min.js",scriptId="pusher-sdk",apiKey="",initOptions={};this.setPusherUrl=function(url){return url&&(scriptUrl=url),this},this.setOptions=function(options){return initOptions=options||initOptions,this},this.setToken=function(token){return apiKey=token||apiKey,this},this.$get=["$document","$timeout","$q","$rootScope","$window","$location",function($document,$timeout,$q,$rootScope,$window){function onSuccess(){pusher=new $window.Pusher(apiKey,initOptions)}var pusher,deferred=$q.defer(),onScriptLoad=function(){onSuccess(),$timeout(function(){deferred.resolve(pusher)})};return createScript($document[0],onScriptLoad),deferred.promise}]}).factory("Pusher",["$rootScope","$q","PusherService",function($rootScope,$q,PusherService){return{subscribe:function(channelName,eventName,callback){var channelDeferred=$q.defer();return PusherService.then(function(pusher){var channel=pusher.channel(channelName)||pusher.subscribe(channelName);channelDeferred.resolve(channel),channel.bind(eventName,function(data){callback&&callback(data),$rootScope.$broadcast(channelName+":"+eventName,data),$rootScope.$digest()})}),channelDeferred.promise},subscribeAll:function(channelName,callback){var channelDeferred=$q.defer();return PusherService.then(function(pusher){var channel=pusher.channel(channelName)||pusher.subscribe(channelName);channelDeferred.resolve(channel),channel.bind_all(function(eventName,data){callback&&callback(eventName,data),$rootScope.$broadcast(channelName+":"+eventName,data),$rootScope.$digest()})}),channelDeferred.promise},unsubscribe:function(channelName){PusherService.then(function(pusher){pusher.channel(channelName)&&pusher.unsubscribe(channelName)})}}}]);